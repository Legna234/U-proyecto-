<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Registro UGMA</title>

<!-- jsQR para decodificar QR desde canvas -->
<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>

<style>
  :root{
    --azul-oscuro: #0a1f44;       /* tono usado en login */
    --amarillo-pastel: #f7e97b;  /* amarillo pastel */
    --blanco: #ffffff;
    --gris-input: #f3f3f3;
    --borde: #cfcfcf;
  }

  /* Reset sencillo */
  * { box-sizing: border-box; margin: 0; padding: 0; }

  body{
    font-family: "Segoe UI", Arial, sans-serif;
    background: var(--azul-oscuro);
    color: var(--azul-oscuro);
    display:flex;
    align-items:center;
    justify-content:center;
    min-height:100vh;
    padding:20px;
  }

  .card {
    width: 380px;
    background: var(--amarillo-pastel);
    border: 2px solid var(--amarillo-pastel);
    border-radius: 12px;
    box-shadow: 0 8px 24px rgba(0,0,0,0.25);
    overflow: hidden;
  }

  .card-inner {
    background: var(--blanco);
    padding: 22px;
    color: var(--azul-oscuro);
  }

  .logo-wrap {
    background: var(--azul-oscuro);
    padding: 14px;
    display:flex;
    justify-content:center;
    align-items:center;
  }

  .logo-wrap img {
    width: 84px;
    height: auto;
    display:block;
  }

  h2 {
    text-align:center;
    font-size:20px;
    margin-bottom:12px;
    color:var(--azul-oscuro);
  }

  label {
    display:block;
    font-weight:600;
    font-size:13px;
    margin-top:10px;
    color:#23384f;
  }

  input[type="text"],
  input[type="password"],
  select {
    width:100%;
    padding:12px 10px;
    margin-top:6px;
    border-radius:8px;
    border:1px solid var(--borde);
    background: var(--gris-input);
    font-size:16px;             /* tama√±o aumentado para legibilidad */
    color: var(--azul-oscuro);
  }

  input[readonly] {
    background:#e9e9e9;
    color:#444;
    cursor:not-allowed;
  }

  .row {
    display:flex;
    gap:8px;
    align-items:center;
  }

  .small-btn {
    padding:10px 12px;
    border-radius:8px;
    border:none;
    background:var(--azul-oscuro);
    color:var(--amarillo-pastel);
    cursor:pointer;
    font-weight:700;
  }

  .main-btn {
    margin-top:14px;
    width:100%;
    padding:12px;
    border-radius:10px;
    border:none;
    background:var(--azul-oscuro);
    color:var(--amarillo-pastel);
    font-weight:800;
    font-size:16px;
    cursor:pointer;
  }

  .main-btn:disabled {
    opacity:0.6;
    cursor:not-allowed;
  }

  #cameraPreview {
    display:block;
    width:100%;
    height:220px;
    border-radius:8px;
    background:#000;
    margin-top:10px;
    object-fit:cover;
    display:none; /* visible s√≥lo durante escaneo */
  }

  #qrStatus {
    font-size:13px;
    margin-top:8px;
    color:#2a4;
  }

  .hint { font-size:13px; color:#556; margin-top:6px; }

  .link-row {
    text-align:center;
    margin-top:12px;
    font-size:14px;
  }

  .link-row a {
    color: var(--azul-oscuro);
    font-weight:700;
    text-decoration:underline;
  }

  /* mostrar/ocultar iconos dentro de inputs */
  .pwd-wrap {
    position:relative;
  }

  .toggle-eye {
    position:absolute;
    right:10px;
    top:50%;
    transform:translateY(-50%);
    background:transparent;
    border:none;
    cursor:pointer;
    font-size:18px;
    color:var(--azul-oscuro);
  }

  /* responsive peque√±o */
  @media (max-width:420px){
    .card { width: 96%; }
  }
</style>
</head>
<body>

<div class="card" role="main">
  <div class="logo-wrap">
    <!-- ajusta la ruta si hace falta -->
    <img src="/assets/ugma_logo.png" alt="UGMA logo">
  </div>

  <div class="card-inner">
    <h2>Registro UGMA</h2>

    <!-- Bot√≥n para abrir c√°mara y escanear QR -->
    <div class="row" style="margin-top:6px;">
      <button id="scanBtn" class="small-btn" type="button">üì∑ Escanear QR</button>
      <button id="stopBtn" class="small-btn" type="button" style="background:#ddd;color:var(--azul-oscuro)">‚úñ Detener</button>
    </div>

    <!-- Preview video para c√°mara -->
    <video id="cameraPreview" autoplay muted playsinline></video>
    <div id="qrStatus" class="hint" aria-live="polite"></div>

    <!-- Tipo de usuario: bloqueado, solo QR asigna -->
    <label for="tipoUsuario">Tipo de usuario</label>
    <input type="text" id="tipoUsuario" readonly placeholder="Escanee el QR para asignar tipo">

    <!-- Nombre de usuario -->
    <label for="nombre">Nombre completo</label>
    <input type="text" id="nombre" placeholder="Tu nombre completo">

    <!-- Cedula editable -->
    <label for="cedula">C√©dula</label>
    <input type="text" id="cedula" placeholder="Ej: 31.103.193 o 31103193">

    <!-- Contrase√±a -->
    <label for="password">Contrase√±a</label>
    <div class="pwd-wrap">
      <input type="password" id="password" placeholder="Contrase√±a (m√≠n. 8 car., 1 n√∫mero)">
      <button class="toggle-eye" type="button" title="Mostrar/ocultar" onclick="togglePass('password')">üëÅ</button>
    </div>

    <!-- Verificar contrase√±a -->
    <label for="confirmPassword">Verificar contrase√±a</label>
    <div class="pwd-wrap">
      <input type="password" id="confirmPassword" placeholder="Repita la contrase√±a">
      <button class="toggle-eye" type="button" title="Mostrar/ocultar" onclick="togglePass('confirmPassword')">üëÅ</button>
    </div>

    <div id="passError" class="hint" style="color:#b33; display:none;">Las contrase√±as no coinciden o no cumplen requisitos.</div>

    <button id="btnRegister" class="main-btn" type="button">Registrar cuenta</button>

    <div class="link-row">
      <div class="login-link">¬øYa tienes cuenta? <a href="/login.html">Inicia sesi√≥n aqu√≠</a></div>
    </div>
  </div>
</div>

<script>
/* ======= Config ======= */
/* Llaves QR de prueba (usa las que generaste) */
const KEY_STUDENT = "UGMA-QR-REGISTER-STUDENT";
const KEY_TEACHER = "UGMA-QR-REGISTER-TEACHER";

/* Elements */
const scanBtn = document.getElementById('scanBtn');
const stopBtn = document.getElementById('stopBtn');
const video = document.getElementById('cameraPreview');
const qrStatus = document.getElementById('qrStatus');
const tipoUsuario = document.getElementById('tipoUsuario');
const cedulaEl = document.getElementById('cedula');
const passwordEl = document.getElementById('password');
const confirmEl = document.getElementById('confirmPassword');
const passError = document.getElementById('passError');
const btnRegister = document.getElementById('btnRegister');

let stream = null;
let scanning = false;

/* ========= Funciones QR ========== */
async function startCameraScan(){
  // si ya escaneando, no volver a iniciar
  if (scanning) return;
  qrStatus.textContent = 'Solicitando c√°mara...';
  try {
    stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
    video.srcObject = stream;
    video.style.display = 'block';
    scanning = true;
    qrStatus.textContent = 'Escaneando QR...';
    requestAnimationFrame(tick);
  } catch (err) {
    console.error(err);
    qrStatus.textContent = 'Error: no se pudo acceder a la c√°mara.';
  }
}

function stopCameraScan(){
  if (stream){
    stream.getTracks().forEach(t => t.stop());
    stream = null;
  }
  scanning = false;
  video.style.display = 'none';
  qrStatus.textContent = '';
}

/* toma frames del video, procesa con jsQR */
function tick(){
  if (!scanning) return;
  if (video.readyState === video.HAVE_ENOUGH_DATA){
    const w = video.videoWidth;
    const h = video.videoHeight;
    const canvas = document.createElement('canvas');
    canvas.width = w;
    canvas.height = h;
    const ctx = canvas.getContext('2d');
    ctx.drawImage(video, 0, 0, w, h);

    const imageData = ctx.getImageData(0, 0, w, h);
    const code = jsQR(imageData.data, w, h, { inversionAttempts: "attemptBoth" });

    if (code && code.data){
      handleQR(code.data);
      stopCameraScan();
      return;
    }
  }
  requestAnimationFrame(tick);
}

/* manejo del contenido del QR */
function handleQR(data){
  const text = String(data).trim();
  qrStatus.textContent = 'QR detectado';
  // asigna tipo solo si corresponde
  if (text.includes(KEY_STUDENT)){
    tipoUsuario.value = 'ESTUDIANTE';
    qrStatus.textContent = 'QR v√°lido ‚Üí ESTUDIANTE';
  } else if (text.includes(KEY_TEACHER)){
    tipoUsuario.value = 'PROFESOR';
    qrStatus.textContent = 'QR v√°lido ‚Üí PROFESOR';
  } else {
    tipoUsuario.value = '';
    qrStatus.textContent = 'QR no v√°lido para registro UGMA';
  }
}

/* ========= Contrase√±a / UI ========= */
function togglePass(id){
  const el = document.getElementById(id);
  el.type = el.type === 'password' ? 'text' : 'password';
}

/* Validaci√≥n de contrase√±a local */
function validarPassword(p){
  if (!p || p.length < 8) return false;
  if (!/\d/.test(p)) return false;
  return true;
}

/* Evento registrar */
btnRegister.addEventListener('click', async () => {
  passError.style.display = 'none';

  const nombre = document.getElementById('nombre')?.value?.trim() || "Sin Nombre";
  const cedula = cedulaEl.value.trim().replace(/\./g,'');
  const rol = tipoUsuario.value === "ESTUDIANTE" ? 1 : (tipoUsuario.value === "PROFESOR" ? 2 : null);
  const clave = passwordEl.value;
  const confirm = confirmEl.value;

  if (!rol){
    alert('Debes escanear un QR v√°lido para seleccionar rol.');
    return;
  }
  if (!cedula){
    alert('Ingresa tu c√©dula.');
    return;
  }
  if (clave !== confirm){
    passError.textContent = "Las contrase√±as no coinciden.";
    passError.style.display = "block";
    return;
  }

  const payload = { cedula, nombre, rol, clave };

  try {
    const res = await fetch('/api/register', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });

    const json = await res.json();

    if (res.ok) {
      alert("Registro exitoso ‚úÖ");
      window.location.href = "/login.html";
    } else {
      alert("Error ‚ùå: " + json.message);
    }

  } catch (error) {
    console.error(error);
    alert("Error de red o servidor ‚ùå");
  }
});


/* Botones de control */
scanBtn.addEventListener('click', startCameraScan);
stopBtn.addEventListener('click', stopCameraScan);

/* limpiar camera cuando cambies de p√°gina */
window.addEventListener('beforeunload', stopCameraScan);
</script>
</body>
</html>
